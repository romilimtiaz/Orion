# agents/llm_planner_agent.py

import requests
import json

OLLAMA_URL = "http://localhost:11434/api/generate"
MODEL = "codellama:instruct"

def plan_command(command):
    prompt = f"""
You are Orion's planner module. Read the user's natural language command and return a JSON object with:
- "agent": one of [file, email, browser, search, calendar, reminder, translate, unknown]
- "info": contains only the extracted values needed for that agent

Respond ONLY in valid JSON format.
DO NOT include any explanation, markdown, or extra text.

Examples:

Command: Translate thank you to Arabic
‚Üí {{"agent": "translate", "info": {{"text": "thank you", "language": "ar"}}}}

Command: Translate good night to French
‚Üí {{"agent": "translate", "info": {{"text": "good night", "language": "fr"}}}}

Command: Schedule project presentation on 2025-06-30 15:00
‚Üí {{"agent": "calendar", "info": {{"event": "project presentation", "datetime": "2025-06-30 15:00"}}}}

Command: Remind me to check oven at 2025-06-24 21:00
‚Üí {{"agent": "reminder", "info": {{"task": "check oven", "datetime": "2025-06-24 21:00"}}}}

Command: \"\"\"{command}\"\"\"
"""

    try:
        response = requests.post(OLLAMA_URL, json={
            "model": MODEL,
            "prompt": prompt,
            "stream": False,
            "stop": ["\n\n"]
        })

        result = response.json()["response"]
        print("\nüß™ Raw LLM response:\n", result)

        # üßº Clean out unwanted formatting like ‚Üí, leading text, newlines
        clean = result.strip()
        if "{" in clean:
            clean = clean[clean.index("{"):]  # Start from first '{'
        
        try:
            parsed = json.loads(clean)
            return parsed
        except Exception as e:
            print("‚ùå JSON parse error:", e)
            return {"agent": "unknown", "info": {}}

    except Exception as e:
        print("‚ùå Planner error:", e)
        return {"agent": "unknown", "info": {}}
